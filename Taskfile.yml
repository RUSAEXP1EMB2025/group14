version: '3'

vars:
  PROJECT_NAME: group14
  SRC_DIR: src
  DIST_DIR: dist
  SCRIPTS_DIR: scripts

env:
  NODE_ENV: development

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  # åŸºæœ¬ã‚¿ã‚¹ã‚¯
  setup:
    desc: é–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€.envãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆï¼‰
    cmds:
      - task: env:copy
      - task: install
      - echo "âœ… é–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"

  install:
    desc: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆDockerçµŒç”±ï¼‰
    cmds:
      - docker build -t {{.PROJECT_NAME}} .
      - docker run --rm -v $(pwd):/app {{.PROJECT_NAME}} bun install
      - echo "âœ… ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸ"

  clean:
    desc: ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    cmds:
      - rm -rf {{.DIST_DIR}}
      - rm -rf node_modules
      - docker rmi {{.PROJECT_NAME}} 2>/dev/null || true
      - echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"

  # é–‹ç™ºç”¨ã‚¿ã‚¹ã‚¯
  dev:
    desc: é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ï¼ˆDocker + ngrokï¼‰
    cmds:
      - docker compose up --build -d
      - echo "âœ… é–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ã—ã¾ã—ãŸ"

  stop:
    desc: Docker Composeã§ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
    cmds:
      - docker compose down
      - echo "âœ… Dockerã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã—ã¾ã—ãŸ"

  logs:
    desc: Docker Composeã®ãƒ­ã‚°è¡¨ç¤º
    cmds:
      - docker compose logs -f

  restart:
    desc: Docker Composeã‚µãƒ¼ãƒ“ã‚¹ã®å†èµ·å‹•
    cmds:
      - task: stop
      - task: dev

  shell:
    desc: ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã‚·ã‚§ãƒ«ã‚’èµ·å‹•
    cmds:
      - docker compose exec app sh

  # ã‚³ãƒ¼ãƒ‰å“è³ªç®¡ç†
  lint:
    desc: Biomeã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ã®é™çš„è§£æ
    deps: [install]
    cmds:
      - docker run --rm -v $(pwd):/app {{.PROJECT_NAME}} bun biome lint {{.SRC_DIR}}/

  lint:fix:
    desc: ãƒªãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ã®è‡ªå‹•ä¿®æ­£
    deps: [install]
    cmds:
      - docker run --rm -v $(pwd):/app {{.PROJECT_NAME}} bun biome lint --write {{.SRC_DIR}}/
      - echo "âœ… ãƒªãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¾ã—ãŸ"

  format:
    desc: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    deps: [install]
    cmds:
      - docker run --rm -v $(pwd):/app {{.PROJECT_NAME}} bun biome format --write {{.SRC_DIR}}/
      - echo "âœ… ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ"

  check:
    desc: ç·åˆçš„ãªã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆãƒªãƒ³ãƒˆ + ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰
    deps: [install]
    cmds:
      - docker run --rm -v $(pwd):/app {{.PROJECT_NAME}} bun biome check --write {{.SRC_DIR}}/
      - echo "âœ… ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"

  # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
  script:run:
    desc: ä»»æ„ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œï¼ˆä¾‹ task script:run -- scripts/your-script.tsï¼‰
    deps: [install]
    cmds:
      - docker run --rm --env-file .env -v $(pwd):/app {{.PROJECT_NAME}} bun run {{.CLI_ARGS}}

  # ç’°å¢ƒæ§‹ç¯‰
  env:copy:
    desc: .env.exampleã‹ã‚‰.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
    cmds:
      - |
        if [ ! -f .env ]; then
          cp .env.example .env
          echo "âœ… .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
        else
          echo "âš ï¸  .envãƒ•ã‚¡ã‚¤ãƒ«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
        fi
    status:
      - test -f .env

  env:check:
    desc: å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
    cmds:
      - |
        if [ -f .env ]; then
          echo "âœ… .envãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™"
          echo "ğŸ“‹ è¨­å®šã•ã‚Œã¦ã„ã‚‹ç’°å¢ƒå¤‰æ•°"
          grep -v '^#' .env | grep -v '^$' || echo "ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
        else
          echo "âŒ .envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'task env:copy'ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
          exit 1
        fi

  # é–‹ç™ºæ”¯æ´ã‚¿ã‚¹ã‚¯
  dev:full:
    desc: å®Œå…¨ãªé–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— + èµ·å‹•ï¼ˆngrokä»˜ãï¼‰
    cmds:
      - task: setup
      - task: dev

  dev:quick:
    desc: ã‚¯ã‚¤ãƒƒã‚¯é–‹ç™ºç’°å¢ƒèµ·å‹•ï¼ˆngrokãªã—ï¼‰
    cmds:
      - task: setup
      - task: dev:app

  # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ»ç›£è¦–
  health:
    desc: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    cmds:
      - curl -f http://localhost:3000/health || echo "âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“"

  # ãƒ‡ãƒãƒƒã‚°ãƒ»æƒ…å ±å–å¾—
  info:
    desc: é–‹ç™ºç’°å¢ƒã®æƒ…å ±è¡¨ç¤º
    cmds:
      - echo "ğŸ“Š Dockerç’°å¢ƒæƒ…å ±"
      - docker compose ps
      - echo "ğŸŒ ãƒ­ãƒ¼ã‚«ãƒ«URL http://localhost:3000"
      - echo "ğŸ“Š Ngrok dashboard http://localhost:4040"
      - echo "ğŸ” ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ task health"

  debug:
    desc: ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¡¨ç¤º
    cmds:
      - echo "ğŸ” Dockeræƒ…å ±"
      - docker version
      - echo "ğŸ” Docker Composeæƒ…å ±"
      - docker compose version
      - echo "ğŸ” å®Ÿè¡Œä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠ"
      - docker ps
      - echo "ğŸ” ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯"
      - task: env:check
